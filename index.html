<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø©</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <style>
    body { font-family: Arial; background: #fff8f0; padding: 20px; }
    h1 { text-align: center; color: #e67e22; }
    select, button, input[type='number'], input[type='text'] {
      margin: 5px; padding: 8px; font-size: 14px; border-radius: 5px; border: 1px solid #ccc;
    }
    .filters { text-align: center; margin-bottom: 20px; }
    .products { display: grid; grid-template-columns: repeat(auto-fill, minmax(220px, 1fr)); gap: 20px; }
    .product { background: white; padding: 15px; border-radius: 10px; border: 1px solid #f0c79b; box-shadow: 0 2px 5px rgba(230, 126, 34, 0.1); text-align: center; }
    .product img { width: 100%; height: 150px; object-fit: contain; margin-bottom: 10px; border-radius: 8px; background-color: #fff0e0; }
    .pagination { text-align: center; margin-top: 20px; }
    .pagination button, .pagination select { margin: 5px; padding: 8px 16px; background: #e67e22; color: white; border: none; border-radius: 5px; cursor: pointer; }
    .pagination button:disabled { background: #ccc; cursor: not-allowed; }
  </style>
</head>
<body>
  <h1>Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¨Ø¶Ø§Ø¹Ø©</h1>
  <p id="lastUpdated" style="text-align:center; color: #999;">Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ«: 2025-05-01</p>
  <div class="filters">
    <label>Ø§Ø®ØªØ± Ø§Ù„ØªØµÙ†ÙŠÙ:
      <select id="categoryFilter"></select>
    </label>
    <input type="text" id="searchInput" placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ù€ Alias..." oninput="renderProducts()" />
    <button onclick="sortBySales()">ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ø£ÙƒØ«Ø± Ù…Ø¨ÙŠØ¹Ù‹Ø§</button>
    <button id="sendOrderBtn" onclick="openOrderModal()" style="display:none;">Ø§Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ÙŠØ©</button>
    <button id="loginBtn" onclick="login()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
  </div>

  <div class="products" id="productContainer"></div>
  <div id="totalSales" style="text-align:center; margin-top: 20px; font-size: 16px; font-weight: bold; color: #e67e22;"></div>
  <div class="pagination" id="pagination"></div>

  <div id="orderModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); align-items:center; justify-content:center;">
    <div style="background:white; padding:20px; border-radius:10px; text-align:center;">
      <h3>ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ÙŠØ©</h3>
      <label>
        <input type="checkbox" id="extraItemsCheckbox" />
        ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªÙ„Ø²Ù…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ© Ù…Ø¹ Ø§Ù„Ø·Ù„Ø¨ÙŠØ©
      </label>
      <br><br>
      <button onclick="submitOrder()">ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø·Ù„Ø¨ÙŠØ©</button>
      <button onclick="closeOrderModal()" style="background:grey;">Ø¥Ù„ØºØ§Ø¡</button>
    </div>
  </div>

  <script src="products.js"></script>
  <script>
    const firebaseConfig = { apiKey: "AIzaSyDBhsMvDPwECDlFNYNkmFXDVq4nWrEejJc", authDomain: "orders-fb3bf.firebaseapp.com", projectId: "orders-fb3bf", storageBucket: "orders-fb3bf.firebasestorage.app", messagingSenderId: "970674722848", appId: "1:970674722848:web:e2e17f7a62bf59e51f0445" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    let currentUser = null;
    let userWarehouse = "";
    let userMall = "";
    const cart = {};
    const productsPerPage = 40;
    let filteredProducts = [], currentPage = 1;

    auth.onAuthStateChanged(async user => {
      currentUser = user;
      document.getElementById('sendOrderBtn').style.display = user ? 'inline-block' : 'none';
      document.getElementById('loginBtn').textContent = user ? 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬' : 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„';

      if (user) {
        const doc = await db.collection("users").doc(user.uid).get();
        userWarehouse = doc.data()?.warehouse ?? "";
        userMall = doc.data()?.mall ?? "";
        populateFilters();
        renderProducts();
      }
    });

    function login() {
      if (currentUser) return auth.signOut();
      const email = prompt("Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ:");
      const password = prompt("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:");
      if (email && password) {
        auth.signInWithEmailAndPassword(email, password).catch(e => alert("ÙØ´Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„: " + e.message));
      }
    }

    function openOrderModal() {
      if (!currentUser) return alert("ÙŠØ±Ø¬Ù‰ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹.");
      document.getElementById('orderModal').style.display = 'flex';
    }

    function closeOrderModal() {
      document.getElementById('orderModal').style.display = 'none';
    }

    async function submitOrder() {
      if (!currentUser) return alert("ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„.");
      if (!userWarehouse || !userMall) return alert("ØªØ¹Ø°Ø± ØªØ­Ø¯ÙŠØ¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….");
      if (Object.keys(cart).length === 0) return alert("ğŸš« Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ÙŠØ© Ø¨Ø¯ÙˆÙ† Ù…Ù†ØªØ¬Ø§Øª");

      const hasExtras = document.getElementById("extraItemsCheckbox").checked;

      db.collection("orders").add({
        mall: userMall,
        warehouse: userWarehouse,
        hasExtras,
        userId: currentUser.uid,
        orders: Object.entries(cart).map(([code, d]) => ({ code, name: d.name, alias: d.alias ?? '', qty: d.qty })),
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      }).then(() => {
        alert("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­");
        closeOrderModal();
      }).catch(err => {
        alert("âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ÙØ¸");
        console.error(err);
      });
    }

    function populateFilters() {
      const categories = [...new Set(data.map(d => d.category))];
      document.getElementById('categoryFilter').innerHTML = '<option value="">Ø§Ù„ÙƒÙ„</option>' + categories.map(c => `<option value="${c}">${c}</option>`).join('');
    }

    function renderProducts() {
      const category = document.getElementById('categoryFilter').value;
      const searchTerm = document.getElementById('searchInput').value.trim().toLowerCase();

      filteredProducts = data.filter(d =>
        d.stock > 20 &&
        d.outlet === userWarehouse &&
        (!category || d.category === category) &&
        (!searchTerm || (d.alias && d.alias.toLowerCase().includes(searchTerm)))
      );

      renderPage(1);
      updateTotalSales();
    }

    function renderPage(page) {
      currentPage = page;
      const start = (page - 1) * productsPerPage;
      const end = start + productsPerPage;
      const productsToShow = filteredProducts.slice(start, end);

      document.getElementById('productContainer').innerHTML = productsToShow.map(d => `
        <div class="product">
          <img loading="lazy" src="images/${d.code}.jpg" alt="${d.name}" onerror="this.src='images/noimage.png'">
          <h4>${d.name}</h4>
          <p>Ø§Ù„Ø³Ø¹Ø±: ${d.price} Ø±ÙŠØ§Ù„</p>
          <p><strong>Ø§Ù„ÙƒÙˆØ¯:</strong> ${d.code}</p>
          <p><strong>Alias:</strong> ${d.alias ?? 'â€”'}</p>
          <p>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø¨Ø§Ø¹Ø©: ${d.sales !== undefined ? d.sales : 'â€”'}</p>
          <p><strong>Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…ØªÙˆÙØ±Ø©:</strong> ${d.stock ?? 'â€”'}</p>
          <input type="number" min="1" placeholder="Ø§Ù„ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©" value="${cart[d.code]?.qty ?? ''}" onchange="addToCart('${d.code}', '${d.name}', this.value)">
        </div>`).join('');

      renderPagination();
    }

    function renderPagination() {
      const totalPages = Math.ceil(filteredProducts.length / productsPerPage);
      let options = '';
      for (let i = 1; i <= totalPages; i++) {
        options += `<option value="${i}" ${i === currentPage ? 'selected' : ''}>${i}</option>`;
      }
      document.getElementById('pagination').innerHTML = `
        <button onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>Ø§Ù„Ø³Ø§Ø¨Ù‚</button>
        Ø§Ø®ØªØ± ØµÙØ­Ø© <select onchange="goToPage(this.value)">${options}</select>
        <button onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Ø§Ù„ØªØ§Ù„ÙŠ</button>`;
    }

    function changePage(page) {
      if (page > 0 && page <= Math.ceil(filteredProducts.length / productsPerPage)) {
        renderPage(page);
      }
    }

    function goToPage(page) {
      renderPage(Number(page));
    }

    function addToCart(code, name, qty) {
      const product = data.find(p => p.code === code);
      if (qty && parseInt(qty) > 0) {
        cart[code] = { name, alias: product.alias ?? '', qty };
      } else {
        delete cart[code];
      }
    }

    function updateTotalSales() {
      const total = filteredProducts.reduce((sum, p) => sum + (p.sales || 0), 0);
      const count = filteredProducts.length;
      const category = document.getElementById('categoryFilter').value;
      const label = category ? `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ø§Ù„Ù…Ø¨Ø§Ø¹Ø© Ù„ØªØµÙ†ÙŠÙ "${category}"` : "Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ÙƒÙ…ÙŠØ§Øª Ø§Ù„Ù…Ø¨Ø§Ø¹Ø© Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©";
      document.getElementById("totalSales").textContent = `${label}: ${total.toLocaleString()} Ù…Ù† ${count} Ù…Ù†ØªØ¬`;
    }
  </script>
</body>
</html>